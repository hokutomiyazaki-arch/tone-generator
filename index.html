<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>Neuro Sound Generator - FNT</title>

```
<!-- PWAå¯¾å¿œ -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/hokutomiyazaki-arch/tone-generator/main/FNT512.png">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
    }

    html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
    }

    /* CSSå¤‰æ•°ã§ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã‚’ç®¡ç† */
    :root {
        --vh: 1vh;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
        background: #ffffff;
        color: #333;
        touch-action: none;
    }

    .side-menu * {
        touch-action: auto;
    }

    .splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        transition: opacity 0.5s ease-out;
    }

    .splash-screen.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .splash-logo {
        width: 150px;
        height: 150px;
        margin-bottom: 30px;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .splash-title {
        font-size: 1.8em;
        font-weight: 300;
        letter-spacing: 1px;
        margin-bottom: 10px;
        text-align: center;
        color: #333;
    }

    .splash-subtitle {
        font-size: 1.1em;
        margin-bottom: 20px;
        opacity: 0.7;
        color: #666;
        font-weight: 300;
    }

    .splash-copyright {
        font-size: 0.85em;
        opacity: 0.5;
        position: absolute;
        bottom: 30px;
        color: #999;
    }

    .app-container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        background: #ffffff;
    }

    .app-header {
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 100;
        flex-shrink: 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .fnt-logo {
        width: 36px;
        height: 36px;
    }

    .app-title {
        font-size: 1.1em;
        font-weight: 400;
        letter-spacing: 0.5px;
        color: #333;
    }

    .menu-toggle {
        position: absolute;
        right: 20px;
        width: 36px;
        height: 36px;
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        color: #333;
        font-size: 1.2em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .menu-toggle:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
        background: #ffffff;
    }

    .play-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        padding: 10px;
    }

    .visualizer-full {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    #spatial3DCanvas {
        width: 100%;
        height: 100%;
    }

    .control-panel {
        position: relative;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        height: 100%;
        pointer-events: none;
    }

    .control-panel > * {
        pointer-events: all;
    }

    .frequency-display {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 15px 25px;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .freq-card {
        text-align: center;
    }

    .freq-label {
        font-size: 0.75em;
        opacity: 0.6;
        margin-bottom: 4px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .freq-value {
        font-size: 1.6em;
        font-weight: 600;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .spatial-info {
        position: absolute;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
        padding: 12px 24px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        font-size: 0.95em;
    }

    #spatialPosition {
        font-weight: 600;
        background: linear-gradient(135deg, #f093fb, #f5576c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .control-buttons {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .control-btn {
        padding: 14px 40px;
        font-size: 1em;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 25px;
        color: white;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.3);
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
    }

    .control-btn.stop {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        box-shadow: 0 6px 25px rgba(240, 147, 251, 0.3);
    }

    .side-menu {
        position: fixed;
        top: 0;
        right: -100%;
        width: 85%;
        max-width: 400px;
        height: 100%;
        height: 100vh;
        height: -webkit-fill-available;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        transition: right 0.3s ease-out;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
    }

    .side-menu.open {
        right: 0;
    }

    .menu-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        color: white;
    }

    .menu-title {
        font-size: 1.2em;
        font-weight: 400;
        letter-spacing: 0.5px;
    }

    .info-button {
        position: absolute;
        top: 12px;
        right: 60px;
        width: 36px;
        height: 36px;
        background: transparent;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        color: #333;
        font-size: 1.1em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .info-button:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .info-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }

    .info-modal.active {
        display: flex;
    }

    .info-content {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 800px;
        height: 85%;
        max-height: 85%;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .info-header {
        padding: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .info-tabs {
        display: flex;
        gap: 15px;
        background: #f5f5f5;
        padding: 10px 20px;
        flex-shrink: 0;
    }

    .info-tab {
        padding: 8px 20px;
        background: transparent;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        color: #666;
        transition: all 0.3s;
        font-size: 0.95em;
    }

    .info-tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .info-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        padding-bottom: 100px;
    }

    .info-body::-webkit-scrollbar {
        width: 4px;
    }

    .info-body::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
    }

    .info-body::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
    }

    .info-body h3 {
        color: #667eea;
        margin: 20px 0 10px;
        font-size: 1.2em;
    }

    .info-body h4 {
        color: #333;
        margin: 15px 0 8px;
        font-size: 1em;
    }

    .info-body p {
        color: #666;
        margin: 10px 0;
        font-size: 0.95em;
        line-height: 1.8;
    }

    .info-body ul {
        color: #666;
        margin: 10px 0 10px 20px;
        font-size: 0.95em;
    }

    .info-body li {
        margin: 5px 0;
        line-height: 1.6;
    }

    .info-close {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .tab-content {
        /* å‰Šé™¤: position, touch-action ãªã©å…¨ã¦å‰Šé™¤ */
    }

    .usage-step {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border-left: 4px solid #667eea;
    }

    .usage-step-title {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 8px;
    }

    .science-box {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
    }

    .frequency-table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
    }

    .frequency-table th {
        background: #667eea;
        color: white;
        padding: 10px;
        text-align: left;
        font-size: 0.9em;
    }

    .frequency-table td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 0.9em;
    }

    .frequency-table tr:hover {
        background: #f5f5f5;
    }

    .menu-close {
        width: 32px;
        height: 32px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .menu-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        padding-bottom: 100px;
    }

    .menu-content::-webkit-scrollbar {
        width: 4px;
    }

    .menu-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
    }

    .menu-content::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 2px;
    }

    .menu-section {
        background: rgba(0, 0, 0, 0.03);
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 20px;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .section-title {
        font-size: 1em;
        margin-bottom: 15px;
        font-weight: 600;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .slider-container {
        margin: 15px 0;
    }

    .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.85em;
        color: #666;
    }

    .slider {
        width: 100%;
        height: 4px;
        border-radius: 2px;
        background: rgba(0, 0, 0, 0.1);
        outline: none;
        -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .preset-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }

    .preset-btn {
        padding: 10px;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        font-size: 0.85em;
    }

    .preset-btn:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .preset-btn .preset-freq {
        font-weight: 600;
        display: block;
        margin-bottom: 2px;
    }

    .preset-btn .preset-desc {
        font-size: 0.75em;
        opacity: 0.7;
    }

    .wave-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }

    .wave-btn {
        padding: 12px;
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        color: #333;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .wave-btn:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateX(3px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .wave-info {
        flex: 1;
    }

    .wave-name {
        font-weight: 600;
        font-size: 0.95em;
    }

    .wave-effect {
        font-size: 0.75em;
        opacity: 0.7;
        margin-top: 2px;
    }

    .wave-freq {
        font-size: 0.8em;
        opacity: 0.6;
        font-weight: 500;
    }

    .checkbox-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 15px;
    }

    .checkbox-container input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }

    .checkbox-container label {
        font-size: 0.9em;
        color: #666;
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 999;
    }

    .menu-overlay.visible {
        opacity: 1;
        pointer-events: all;
    }

    .app-footer {
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        text-align: center;
        font-size: 0.75em;
        color: #999;
        flex-shrink: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 768px) {
        .info-content {
            width: 95%;
            height: 90%;
            margin: 5% auto;
        }
        
        .info-body {
            padding: 20px;
            height: calc(100% - 110px);
        }
        
        .frequency-table {
            font-size: 0.8em;
        }
        
        .frequency-table th,
        .frequency-table td {
            padding: 8px 5px;
        }
    }
    
    @media (max-height: 700px) {
        .frequency-display {
            margin-top: 10px;
            padding: 10px 20px;
        }
        
        .control-buttons {
            margin-bottom: 10px;
        }
        
        .freq-value {
            font-size: 1.3em;
        }
    }

    @supports (-webkit-touch-callout: none) {
        .app-container {
            height: 100vh;
            height: -webkit-fill-available;
        }
    }
</style>
```

</head>
<body>
    <!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
    <div class="splash-screen" id="splashScreen">
        <img src="https://raw.githubusercontent.com/hokutomiyazaki-arch/tone-generator/main/FNT512.png" alt="FNT Logo" class="splash-logo" id="splashLogo">
        <div class="splash-title">Functional Neuro Training</div>
        <div class="splash-subtitle">Neuro Sound Generator</div>
        <div class="splash-copyright">Â© 2024 Functional Neuro Training. All rights reserved.</div>
    </div>

```
<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div class="app-container" id="appContainer" style="display: none;">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/hokutomiyazaki-arch/tone-generator/main/FNT512-transparent.png" alt="FNT" class="fnt-logo" id="headerLogo">
            <span class="app-title">Neuro Sound Generator</span>
        </div>
        <button class="info-button" onclick="openInfoModal()">â„¹ï¸</button>
        <button class="menu-toggle" id="menuToggle" onclick="toggleMenu()">â˜°</button>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="play-screen">
            <!-- å…¨ç”»é¢3Dãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ -->
            <div class="visualizer-full">
                <canvas id="spatial3DCanvas"></canvas>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
            <div class="control-panel">
                <!-- å‘¨æ³¢æ•°è¡¨ç¤ºï¼ˆä¸Šéƒ¨ï¼‰ -->
                <div class="frequency-display">
                    <div class="freq-card">
                        <div class="freq-label">Left</div>
                        <div class="freq-value" id="leftFreqDisplay">440 Hz</div>
                    </div>
                    <div class="freq-card">
                        <div class="freq-label">Right</div>
                        <div class="freq-value" id="rightFreqDisplay">448 Hz</div>
                    </div>
                </div>

                <!-- ç©ºé–“æƒ…å ±ï¼ˆä¸‹éƒ¨å¤–å´ï¼‰ -->
                <div class="spatial-info">
                    <span>Position: </span>
                    <span id="spatialPosition">Center</span>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
                <div class="control-buttons">
                    <button class="control-btn" id="playBtn" onclick="togglePlay()">â–¶ PLAY</button>
                    <button class="control-btn stop" id="stopBtn" onclick="stopSound()" style="display: none;">â¹ STOP</button>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="app-footer">
        Â© 2024 Functional Neuro Training. All rights reserved.
    </footer>
</div>

<!-- æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="info-modal" id="infoModal" onclick="closeInfoModalOnBackground(event)">
    <div class="info-content" onclick="event.stopPropagation()">
        <div class="info-header">
            <span class="menu-title">Neuro Sound Generator - Guide</span>
            <button class="info-close" onclick="closeInfoModal()">âœ•</button>
        </div>
        
        <div class="info-tabs">
            <button class="info-tab active" onclick="switchTab('usage')">ä½¿ã„æ–¹</button>
            <button class="info-tab" onclick="switchTab('science')">ç¥çµŒç§‘å­¦</button>
        </div>
        
        <div class="info-body" id="infoBody">
            <!-- ä½¿ã„æ–¹ã‚¿ãƒ– -->
            <div id="usageTab" class="tab-content">
                <h3>ğŸ§ åŸºæœ¬çš„ãªä½¿ã„æ–¹</h3>
                
                <div class="usage-step">
                    <div class="usage-step-title">Step 1: ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ã®æº–å‚™</div>
                    <p>â€¢ é«˜å“è³ªãªã‚¹ãƒ†ãƒ¬ã‚ªãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ã¾ãŸã¯ã‚¤ãƒ¤ãƒ•ã‚©ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„<br>
                    â€¢ éª¨ä¼å°ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨å‰åº­å™¨å®˜ã¸ã®åˆºæ¿€ã‚‚å¯èƒ½ã§ã™<br>
                    â€¢ éŸ³é‡ã¯å¿«é©ãªãƒ¬ãƒ™ãƒ«ã«èª¿æ•´ã—ã¦ãã ã•ã„ï¼ˆå¤§éŸ³é‡ã¯é¿ã‘ã¦ãã ã•ã„ï¼‰</p>
                </div>
                
                <div class="usage-step">
                    <div class="usage-step-title">Step 2: ç›®çš„ã«å¿œã˜ãŸè¨­å®š</div>
                    <p><strong>ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ»ç‘æƒ³ï¼š</strong>Alphaæ³¢ï¼ˆ8-13Hzï¼‰ã¾ãŸã¯Thetaæ³¢ï¼ˆ4-8Hzï¼‰<br>
                    <strong>é›†ä¸­ãƒ»ä½œæ¥­ï¼š</strong>Betaæ³¢ï¼ˆ13-30Hzï¼‰<br>
                    <strong>æ·±ã„ä¼‘æ¯ï¼š</strong>Deltaæ³¢ï¼ˆ0.5-4Hzï¼‰<br>
                    <strong>å‰µé€ æ€§å‘ä¸Šï¼š</strong>Gammaæ³¢ï¼ˆ30-50Hzï¼‰</p>
                </div>
                
                <div class="usage-step">
                    <div class="usage-step-title">Step 3: ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ â†’ åˆºæ¿€ â†’ å†è©•ä¾¡</div>
                    <p>1. <strong>åˆºæ¿€å‰ï¼š</strong>ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¨˜éŒ²ï¼ˆé›†ä¸­åŠ›ã€æ°—åˆ†ã€ãƒãƒ©ãƒ³ã‚¹æ„Ÿãªã©ï¼‰<br>
                    2. <strong>åˆºæ¿€ä¸­ï¼š</strong>5-15åˆ†é–“ç¶™ç¶šã—ã¦è´å–<br>
                    3. <strong>åˆºæ¿€å¾Œï¼š</strong>å¤‰åŒ–ã‚’ç¢ºèªã—ã€åŠ¹æœçš„ãªè¨­å®šã‚’è¨˜éŒ²</p>
                </div>
                
                <h3>âš™ï¸ å„æ©Ÿèƒ½ã®è©³ç´°</h3>
                
                <h4>ğŸšï¸ å‘¨æ³¢æ•°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h4>
                <p>å·¦å³ã®è€³ã«ç•°ãªã‚‹å‘¨æ³¢æ•°ã‚’è¨­å®šã§ãã¾ã™ã€‚å‘¨æ³¢æ•°ã®å·®ãŒãƒã‚¤ãƒãƒ¼ãƒ©ãƒ«ãƒ“ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€ç‰¹å®šã®è„³æ³¢ã‚’èª˜å°ã—ã¾ã™ã€‚</p>
                
                <h4>ğŸ­ 3Dç©ºé–“éŸ³éŸ¿</h4>
                <p><strong>Smooth Movementï¼š</strong>éŸ³æºãŒæ»‘ã‚‰ã‹ã«ç§»å‹•ã—ã€éŸ³æºå®šä½ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«<br>
                <strong>Manual Modeï¼š</strong>ç”»é¢ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦éŸ³æºä½ç½®ã‚’æ‰‹å‹•ã§åˆ¶å¾¡<br>
                <strong>Movement Speedï¼š</strong>éŸ³æºã®ç§»å‹•é€Ÿåº¦ã‚’èª¿æ•´</p>
                
                <h4>ğŸµ BPMè¨­å®š</h4>
                <p>éŸ³é‡ã®ãƒ‘ãƒ«ã‚¹ãƒªã‚ºãƒ ã‚’è¨­å®šã€‚ãƒªã‚ºãƒŸã‚«ãƒ«ãªåˆºæ¿€ã«ã‚ˆã‚Šã€ã‚ˆã‚ŠåŠ¹æœçš„ãªç¥çµŒåŒèª¿ã‚’ä¿ƒé€²ã—ã¾ã™ã€‚</p>
                
                <h4>ğŸ¦´ éª¨ä¼å°ãƒ¢ãƒ¼ãƒ‰ï¼ˆ100Hz/500Hz ãƒ—ãƒªã‚»ãƒƒãƒˆï¼‰</h4>
                <p>éª¨ä¼å°ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³ä½¿ç”¨æ™‚ã«å‰åº­å™¨å®˜ã‚’åˆºæ¿€ï¼š<br>
                â€¢ <strong>100Hzï¼š</strong>è€³çŸ³å™¨ï¼‹ä¸‰åŠè¦ç®¡ã¸ã®åˆºæ¿€<br>
                â€¢ <strong>500Hzï¼š</strong>ä¸»ã«è€³çŸ³å™¨ã¸ã®åˆºæ¿€</p>
                
                <h3>ğŸ’¡ åŠ¹æœçš„ãªä½¿ç”¨ã®ãƒ’ãƒ³ãƒˆ</h3>
                <ul>
                    <li>åˆã‚ã¯çŸ­æ™‚é–“ï¼ˆ5åˆ†ç¨‹åº¦ï¼‰ã‹ã‚‰é–‹å§‹ã—ã€å¾ã€…ã«æ™‚é–“ã‚’å»¶ã°ã™</li>
                    <li>åŒã˜æ™‚é–“å¸¯ã«å®šæœŸçš„ã«ä½¿ç”¨ã™ã‚‹ã¨åŠ¹æœãŒå®‰å®šã—ã‚„ã™ã„</li>
                    <li>ç›®ã‚’é–‰ã˜ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸçŠ¶æ…‹ã§ä½¿ç”¨ã™ã‚‹ã¨åŠ¹æœçš„</li>
                    <li>å€‹äººå·®ãŒã‚ã‚‹ãŸã‚ã€è‡ªåˆ†ã«åˆã£ãŸè¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒé‡è¦</li>
                    <li>ã‚ã¾ã„ã‚„ä¸å¿«æ„Ÿã‚’æ„Ÿã˜ãŸã‚‰ã™ãã«ä½¿ç”¨ã‚’ä¸­æ­¢</li>
                </ul>
            </div>
            
            <!-- ç¥çµŒç§‘å­¦ã‚¿ãƒ– -->
            <div id="scienceTab" class="tab-content" style="display: none;">
                <h3>ğŸ§  ç¥çµŒç§‘å­¦çš„èƒŒæ™¯</h3>
                
                <div class="science-box">
                    <h4>éŸ³æºå®šä½ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆ3D Spatial Audioï¼‰</h4>
                    <p><strong>é–¢é€£ç¥çµŒæ§‹é€ ï¼š</strong>ä¸‹ä¸˜ã€ä¸Šã‚ªãƒªãƒ¼ãƒ–è¤‡åˆä½“ã€è´è¦šé‡</p>
                    <p>éŸ³æºãŒ3æ¬¡å…ƒç©ºé–“ã‚’ç§»å‹•ã™ã‚‹ã“ã¨ã§ä»¥ä¸‹ãŒæ´»æ€§åŒ–ã•ã‚Œã¾ã™ï¼š<br>
                    â€¢ <strong>ä¸¡è€³é–“æ™‚é–“å·®ï¼ˆITDï¼‰å‡¦ç†ï¼š</strong>éŸ³ãŒå·¦å³ã®è€³ã«åˆ°é”ã™ã‚‹æ™‚é–“å·®ã‚’æ¤œå‡º<br>
                    â€¢ <strong>ä¸¡è€³é–“éŸ³åœ§å·®ï¼ˆILDï¼‰å‡¦ç†ï¼š</strong>å·¦å³ã®éŸ³é‡å·®ã‹ã‚‰æ°´å¹³é¢ã®å®šä½ã‚’åˆ¤æ–­<br>
                    â€¢ <strong>ã‚¹ãƒšã‚¯ãƒˆãƒ«æ‰‹ãŒã‹ã‚Šå‡¦ç†ï¼š</strong>å‘¨æ³¢æ•°ç‰¹æ€§ã®å¤‰åŒ–ã‹ã‚‰å‚ç›´é¢ãƒ»å‰å¾Œã®å®šä½ã‚’åˆ¤æ–­</p>
                    <p>ã“ã‚Œã‚‰ã¯è„³å¹¹ã®ä¸‹ä¸˜ã§çµ±åˆã•ã‚Œã€å¤§è„³çš®è³ªã®è´è¦šé‡ï¼ˆA1é‡ã¨ãƒ™ãƒ«ãƒˆé ˜åŸŸï¼‰ã§ç©ºé–“ãƒãƒƒãƒ—ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¾ã™ã€‚</p>
                </div>
                
                <div class="science-box">
                    <h4>å‘¨æ³¢æ•°é¸æŠçš„åˆºæ¿€</h4>
                    <p><strong>é–¢é€£ç¥çµŒæ§‹é€ ï¼š</strong>è¸ç‰›ç¥çµŒï¼ˆCN VIIIï¼‰ã€ä¸€æ¬¡è´è¦šé‡ã®ãƒˆãƒãƒˆãƒ”ãƒ¼é…åˆ—</p>
                    <p>â€¢ <strong>åŸºåº•è†œã®å ´æ‰€ç†è«–ï¼š</strong>ç•°ãªã‚‹å‘¨æ³¢æ•°ã¯è¸ç‰›ã®ç•°ãªã‚‹éƒ¨ä½ã‚’åˆºæ¿€<br>
                    â€¢ <strong>100Hzï¼š</strong>è¸ç‰›é ‚éƒ¨ã‚’åˆºæ¿€ã€å‰åº­å™¨å®˜ã«ã‚‚æŒ¯å‹•ãŒä¼ã‚ã‚Šã‚„ã™ã„<br>
                    â€¢ <strong>500Hzï¼š</strong>ä¸­é–“éƒ¨ã‚’åˆºæ¿€ã€éŸ³å£°çŸ¥è¦šã«é‡è¦ãªå¸¯åŸŸ<br>
                    â€¢ <strong>é«˜å‘¨æ³¢æ•°ï¼ˆ1000Hzä»¥ä¸Šï¼‰ï¼š</strong>è¸ç‰›åŸºéƒ¨ã‚’åˆºæ¿€ã€ç©ºé–“å®šä½ã«é‡è¦</p>
                </div>
                
                <h3>ğŸŒŠ ãƒã‚¤ãƒãƒ¼ãƒ©ãƒ«ãƒ“ãƒ¼ãƒˆåŠ¹æœ</h3>
                <p>å·¦å³ã®è€³ã«ç•°ãªã‚‹å‘¨æ³¢æ•°ã‚’æç¤ºã™ã‚‹ã¨ã€è„³ã¯ä¸¡å‘¨æ³¢æ•°ã®å·®åˆ†ã‚’çŸ¥è¦šã—ã€ãã®å‘¨æ³¢æ•°ã§ç¥çµŒæ´»å‹•ãŒåŒèª¿ã—ã¾ã™ã€‚</p>
                
                <table class="frequency-table">
                    <thead>
                        <tr>
                            <th>è„³æ³¢</th>
                            <th>å‘¨æ³¢æ•°å·®</th>
                            <th>åŠ¹æœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Deltaæ³¢</strong></td>
                            <td>0.5-4Hz</td>
                            <td>æ·±ç¡çœ ã€ç´°èƒä¿®å¾©ã€æˆé•·ãƒ›ãƒ«ãƒ¢ãƒ³åˆ†æ³Œ</td>
                        </tr>
                        <tr>
                            <td><strong>Thetaæ³¢</strong></td>
                            <td>4-8Hz</td>
                            <td>REMç¡çœ ã€è¨˜æ†¶ã®å›ºå®šã€å‰µé€ æ€§</td>
                        </tr>
                        <tr>
                            <td><strong>Alphaæ³¢</strong></td>
                            <td>8-13Hz</td>
                            <td>ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</td>
                        </tr>
                        <tr>
                            <td><strong>Betaæ³¢</strong></td>
                            <td>13-30Hz</td>
                            <td>é›†ä¸­ã€å®Ÿè¡Œæ©Ÿèƒ½ã€ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒª</td>
                        </tr>
                        <tr>
                            <td><strong>Gammaæ³¢</strong></td>
                            <td>30-50Hz</td>
                            <td>æ„è­˜ã®çµ±åˆã€é«˜æ¬¡èªçŸ¥æ©Ÿèƒ½</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="science-box">
                    <h4>éª¨ä¼å°ã«ã‚ˆã‚‹å‰åº­åˆºæ¿€</h4>
                    <p><strong>è€³çŸ³å™¨åˆºæ¿€ï¼ˆ100-500Hzï¼‰ï¼š</strong><br>
                    â€¢ åµå½¢åš¢ã¨çƒå½¢åš¢ã®æœ‰æ¯›ç´°èƒã‚’æŒ¯å‹•åˆºæ¿€<br>
                    â€¢ é‡åŠ›æ„Ÿè¦šã¨ç›´ç·šåŠ é€Ÿåº¦ã®çŸ¥è¦šã‚’æ´»æ€§åŒ–</p>
                    
                    <p><strong>ä¸‰åŠè¦ç®¡ã¸ã®å½±éŸ¿ï¼ˆ100Hzä»˜è¿‘ï¼‰ï¼š</strong><br>
                    â€¢ å›è»¢æ„Ÿè¦šã®å‡¦ç†ç³»ã‚’åˆºæ¿€<br>
                    â€¢ å‰åº­-çœ¼åå°„ï¼ˆVORï¼‰ã®èª¿æ•´</p>
                    
                    <p><strong>å‰åº­-è‡ªå¾‹ç¥çµŒç³»ã®é€£æºï¼š</strong><br>
                    â€¢ äº¤æ„Ÿç¥çµŒ/å‰¯äº¤æ„Ÿç¥çµŒãƒãƒ©ãƒ³ã‚¹ã®èª¿æ•´<br>
                    â€¢ è¦šé†’ãƒ¬ãƒ™ãƒ«ã®æœ€é©åŒ–</p>
                </div>
                
                <h3>âš¡ çµ±åˆçš„ç¥çµŒåˆºæ¿€</h3>
                <p>ã“ã‚Œã‚‰ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å€‹äººã«æœ€é©åŒ–ã•ã‚ŒãŸç¥çµŒåˆºæ¿€ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½œæˆã§ãã¾ã™ï¼š</p>
                <ul>
                    <li><strong>è´è¦š-å‰åº­çµ±åˆï¼š</strong>ç©ºé–“èªçŸ¥ã¨ãƒãƒ©ãƒ³ã‚¹æ©Ÿèƒ½ã®å‘ä¸Š</li>
                    <li><strong>è„³æ³¢-èªçŸ¥æ©Ÿèƒ½é€£æºï¼š</strong>ã‚¿ã‚¹ã‚¯ã«å¿œã˜ãŸæœ€é©ãªè„³çŠ¶æ…‹ã®èª˜å°</li>
                    <li><strong>ç¥çµŒå¯å¡‘æ€§ã®ä¿ƒé€²ï¼š</strong>æ–°ã—ã„ç¥çµŒå›è·¯ã®å½¢æˆã¨æ—¢å­˜å›è·¯ã®å¼·åŒ–</li>
                </ul>
                
                <h3>ğŸ”¬ ç¥çµŒç§‘å­¦çš„åŸç†</h3>
                <p>â€¢ <strong>ãƒ˜ãƒ–å‰‡ï¼š</strong>åŒæ™‚ã«ç™ºç«ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ãƒ­ãƒ³é–“ã®çµåˆãŒå¼·åŒ–ã•ã‚Œã‚‹<br>
                â€¢ <strong>å‘¨æ³¢æ•°è¿½éšåå¿œï¼ˆFFRï¼‰ï¼š</strong>è´è¦šç³»ãŒå¤–éƒ¨ãƒªã‚ºãƒ ã«åŒèª¿ã™ã‚‹ç¾è±¡<br>
                â€¢ <strong>ã‚¯ãƒ­ã‚¹ãƒ¢ãƒ¼ãƒ€ãƒ«å¯å¡‘æ€§ï¼š</strong>ç•°ãªã‚‹æ„Ÿè¦šç³»ã®ç›¸äº’ä½œç”¨ã«ã‚ˆã‚‹å­¦ç¿’ä¿ƒé€²<br>
                â€¢ <strong>ãƒ›ãƒ¡ã‚ªã‚¹ã‚¿ã‚·ã‚¹å¯å¡‘æ€§ï¼š</strong>ç¥çµŒç³»ã®é©å¿œçš„ãªèª¿æ•´ãƒ¡ã‚«ãƒ‹ã‚ºãƒ </p>
            </div>
        </div>
    </div>
</div>

<!-- ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
<nav class="side-menu" id="sideMenu">
    <div class="menu-header">
        <span class="menu-title">Settings</span>
        <button class="menu-close" onclick="closeMenu()">âœ•</button>
    </div>
    
    <div class="menu-content">
        <!-- å‘¨æ³¢æ•°èª¿æ•´ -->
        <div class="menu-section">
            <div class="section-title">ğŸšï¸ Frequency Control</div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Left Ear</span>
                    <span id="leftFreqLabel">440 Hz</span>
                </div>
                <input type="range" class="slider" id="leftFreq" min="20" max="20000" value="440" step="1">
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Right Ear</span>
                    <span id="rightFreqLabel">448 Hz</span>
                </div>
                <input type="range" class="slider" id="rightFreq" min="20" max="20000" value="448" step="1">
            </div>

            <div class="preset-grid">
                <button class="preset-btn" onclick="setPresetFrequency('left', 100)">
                    <span class="preset-freq">L: 100Hz</span>
                    <span class="preset-desc">è€³çŸ³å™¨ï¼‹ä¸‰åŠè¦ç®¡<br>(éª¨ä¼å°æ¨å¥¨)</span>
                </button>
                <button class="preset-btn" onclick="setPresetFrequency('left', 500)">
                    <span class="preset-freq">L: 500Hz</span>
                    <span class="preset-desc">è€³çŸ³å™¨<br>(éª¨ä¼å°æ¨å¥¨)</span>
                </button>
                <button class="preset-btn" onclick="setPresetFrequency('right', 100)">
                    <span class="preset-freq">R: 100Hz</span>
                    <span class="preset-desc">è€³çŸ³å™¨ï¼‹ä¸‰åŠè¦ç®¡<br>(éª¨ä¼å°æ¨å¥¨)</span>
                </button>
                <button class="preset-btn" onclick="setPresetFrequency('right', 500)">
                    <span class="preset-freq">R: 500Hz</span>
                    <span class="preset-desc">è€³çŸ³å™¨<br>(éª¨ä¼å°æ¨å¥¨)</span>
                </button>
            </div>
        </div>

        <!-- è„³æ³¢ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
        <div class="menu-section">
            <div class="section-title">ğŸ§  Brainwave Presets</div>
            <div class="wave-buttons">
                <button class="wave-btn" onclick="setBrainwavePreset('delta')">
                    <div class="wave-info">
                        <div class="wave-name">Delta Wave</div>
                        <div class="wave-effect">æ·±ã„ç¡çœ ãƒ»ç´°èƒå†ç”Ÿãƒ»æ²»ç™’ä¿ƒé€²</div>
                    </div>
                    <div class="wave-freq">0.5-4Hz</div>
                </button>
                <button class="wave-btn" onclick="setBrainwavePreset('theta')">
                    <div class="wave-info">
                        <div class="wave-name">Theta Wave</div>
                        <div class="wave-effect">ç‘æƒ³ãƒ»ç›´æ„Ÿãƒ»è¨˜æ†¶åŠ›å‘ä¸Šãƒ»å‰µé€ æ€§</div>
                    </div>
                    <div class="wave-freq">4-8Hz</div>
                </button>
                <button class="wave-btn" onclick="setBrainwavePreset('alpha')">
                    <div class="wave-info">
                        <div class="wave-name">Alpha Wave</div>
                        <div class="wave-effect">ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›ãƒ»å­¦ç¿’åŠ¹ç‡å‘ä¸Š</div>
                    </div>
                    <div class="wave-freq">8-13Hz</div>
                </button>
                <button class="wave-btn" onclick="setBrainwavePreset('beta')">
                    <div class="wave-info">
                        <div class="wave-name">Beta Wave</div>
                        <div class="wave-effect">é›†ä¸­åŠ›ãƒ»å•é¡Œè§£æ±ºãƒ»æ´»ç™ºãªæ€è€ƒ</div>
                    </div>
                    <div class="wave-freq">13-30Hz</div>
                </button>
                <button class="wave-btn" onclick="setBrainwavePreset('gamma')">
                    <div class="wave-info">
                        <div class="wave-name">Gamma Wave</div>
                        <div class="wave-effect">é«˜æ¬¡èªçŸ¥ãƒ»æ„è­˜çµ±åˆãƒ»æ‚Ÿã‚Š</div>
                    </div>
                    <div class="wave-freq">30-50Hz</div>
                </button>
            </div>
            <div style="margin-top: 15px; text-align: center; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 8px;">
                <span style="color: #666;">Frequency Difference: </span>
                <span id="freqDifference" style="color: #667eea; font-weight: 600;">8 Hz</span>
                <span id="currentWaveType" style="color: #999; font-size: 0.85em;">(Alpha)</span>
            </div>
        </div>

        <!-- éŸ³é‡èª¿æ•´ -->
        <div class="menu-section">
            <div class="section-title">ğŸ”Š Volume Control</div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Master Volume</span>
                    <span id="volumeLabel">70%</span>
                </div>
                <input type="range" class="slider" id="volumeSlider" min="0" max="100" value="70" step="1">
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Left Volume</span>
                    <span id="leftVolumeLabel">70%</span>
                </div>
                <input type="range" class="slider" id="leftVolumeSlider" min="0" max="100" value="70" step="1">
            </div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Right Volume</span>
                    <span id="rightVolumeLabel">70%</span>
                </div>
                <input type="range" class="slider" id="rightVolumeSlider" min="0" max="100" value="70" step="1">
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="preset-btn" id="leftMuteBtn" onclick="toggleLeftMute()" style="flex: 1;">
                    <span id="leftMuteText">Left ON</span>
                </button>
                <button class="preset-btn" id="rightMuteBtn" onclick="toggleRightMute()" style="flex: 1;">
                    <span id="rightMuteText">Right ON</span>
                </button>
            </div>
        </div>

        <!-- BPMè¨­å®š -->
        <div class="menu-section">
            <div class="section-title">ğŸµ BPM Settings</div>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>BPM</span>
                    <span id="bpmLabel">120 BPM</span>
                </div>
                <input type="range" class="slider" id="bpmSlider" min="30" max="300" value="120" step="1">
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="randomBpm">
                <label for="randomBpm">Random BPM (60-180)</label>
            </div>
        </div>

        <!-- 3DéŸ³éŸ¿è¨­å®š -->
        <div class="menu-section">
            <div class="section-title">ğŸ­ 3D Spatial Audio</div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="spatialAudio" onchange="toggleSpatialAudio()">
                <label for="spatialAudio">Enable 3D Spatial Audio</label>
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="smoothMovement" onchange="toggleSmoothMovement()">
                <label for="smoothMovement">Smooth Movement</label>
            </div>
            
            <div class="slider-container" id="movementSpeedControl" style="display: none;">
                <div class="slider-label">
                    <span>Movement Speed</span>
                    <span id="speedLabel">Normal</span>
                </div>
                <input type="range" class="slider" id="speedSlider" min="0.5" max="3" value="1" step="0.1">
            </div>
            
            <div class="checkbox-container">
                <input type="checkbox" id="manualMode" onchange="toggleManualMode()">
                <label for="manualMode">Manual Mode (Drag to Control)</label>
            </div>
            
            <div class="slider-container" id="heightControl" style="display: none;">
                <div class="slider-label">
                    <span>Height</span>
                    <span id="heightLabel">Center</span>
                </div>
                <input type="range" class="slider" id="heightSlider" min="-1" max="1" value="0" step="0.1">
            </div>
        </div>
    </div>
</nav>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let audioContext = null;
    let leftOscillator = null;
    let rightOscillator = null;
    let leftGain = null;
    let rightGain = null;
    let merger = null;
    let isPlaying = false;
    let bpmInterval = null;
    let randomBpmInterval = null;
    let leftMuted = false;
    let rightMuted = false;
    let masterVolume = 0.7;
    let leftVolume = 0.7;
    let rightVolume = 0.7;
    let spatialAudioActive = false;
    let spatialInterval = null;
    let pannerNode = null;
    let isDragging = false;
    let manualMode = false;
    let currentSoundX = 0;
    let currentSoundY = 0;
    let currentSoundZ = 0;
    let targetSoundX = 0;
    let targetSoundY = 0;
    let targetSoundZ = 0;
    let canvas = null;
    let ctx = null;
    let lowpassFilter = null;
    let highpassFilter = null;
    let githubRepo = 'hokutomiyazaki-arch/tone-generator';
    let smoothMovement = false;
    let movementSpeed = 1;
    let smoothAnimationFrame = null;
    let movementTime = 0;
    let movementPath = null;
    let pathProgress = 0;
    let soundTrail = [];

    // PWA Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful');
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        updateLogoUrls();
        setupFullscreen();
        
        // ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®å‡¦ç†
        setTimeout(() => {
            console.log('Hiding splash screen');
            document.getElementById('splashScreen').classList.add('hidden');
            document.getElementById('appContainer').style.display = 'flex';
            initializeApp();
        }, 2000);
    });

    // ãƒ­ã‚´URLã®æ›´æ–°
    function updateLogoUrls() {
        const baseUrl = `https://raw.githubusercontent.com/${githubRepo}/main/`;
        
        const splashLogo = document.getElementById('splashLogo');
        if (splashLogo) {
            splashLogo.src = baseUrl + 'FNT512.png';
            splashLogo.onerror = function() {
                console.log('Splash logo failed to load');
            };
        }
        
        const headerLogo = document.getElementById('headerLogo');
        if (headerLogo) {
            headerLogo.src = baseUrl + 'FNT512-transparent.png';
            headerLogo.onerror = function() {
                console.log('Header logo failed to load');
            };
        }
    }

    // å…¨ç”»é¢è¨­å®š
    function setupFullscreen() {
        document.addEventListener('click', enterFullscreenOnce);
        document.addEventListener('touchstart', enterFullscreenOnce);
        
        document.addEventListener('touchmove', function(e) {
            if (!e.target.closest('.menu-content')) {
                e.preventDefault();
            }
        }, { passive: false });
        
        document.body.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    }

    function enterFullscreenOnce() {
        enterFullscreen();
        document.removeEventListener('click', enterFullscreenOnce);
        document.removeEventListener('touchstart', enterFullscreenOnce);
    }

    function enterFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(() => {});
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
    }

    // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
    function initializeApp() {
        console.log('Initializing app');
        canvas = document.getElementById('spatial3DCanvas');
        ctx = canvas.getContext('2d');
        
        canvas.addEventListener('mousedown', startDrag);
        canvas.addEventListener('mousemove', drag);
        canvas.addEventListener('mouseup', endDrag);
        canvas.addEventListener('mouseleave', endDrag);
        canvas.addEventListener('touchstart', startDrag);
        canvas.addEventListener('touchmove', drag);
        canvas.addEventListener('touchend', endDrag);
        
        updateFrequencyDifference();
        draw3DSpace();
        setupEventListeners();
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡
    function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('menuOverlay');
        
        if (menu.classList.contains('open')) {
            closeMenu();
        } else {
            menu.classList.add('open');
            overlay.classList.add('visible');
        }
    }

    function closeMenu() {
        document.getElementById('sideMenu').classList.remove('open');
        document.getElementById('menuOverlay').classList.remove('visible');
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
        document.getElementById('leftFreq').addEventListener('input', function() {
            const freq = this.value;
            document.getElementById('leftFreqLabel').textContent = freq + ' Hz';
            document.getElementById('leftFreqDisplay').textContent = freq + ' Hz';
            updateFrequencyDifference();
            if (leftOscillator) {
                leftOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
        });

        document.getElementById('rightFreq').addEventListener('input', function() {
            const freq = this.value;
            document.getElementById('rightFreqLabel').textContent = freq + ' Hz';
            document.getElementById('rightFreqDisplay').textContent = freq + ' Hz';
            updateFrequencyDifference();
            if (rightOscillator) {
                rightOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
        });

        document.getElementById('volumeSlider').addEventListener('input', function() {
            masterVolume = this.value / 100;
            document.getElementById('volumeLabel').textContent = this.value + '%';
            if (isPlaying) updateVolume();
        });

        document.getElementById('leftVolumeSlider').addEventListener('input', function() {
            leftVolume = this.value / 100;
            document.getElementById('leftVolumeLabel').textContent = this.value + '%';
            if (isPlaying && leftGain && !leftMuted) {
                leftGain.gain.setValueAtTime(0.3 * masterVolume * leftVolume, audioContext.currentTime);
            }
        });

        document.getElementById('rightVolumeSlider').addEventListener('input', function() {
            rightVolume = this.value / 100;
            document.getElementById('rightVolumeLabel').textContent = this.value + '%';
            if (isPlaying && rightGain && !rightMuted) {
                rightGain.gain.setValueAtTime(0.3 * masterVolume * rightVolume, audioContext.currentTime);
            }
        });

        document.getElementById('bpmSlider').addEventListener('input', function() {
            const bpm = this.value;
            document.getElementById('bpmLabel').textContent = bpm + ' BPM';
            if (isPlaying) updateBPM(bpm);
        });

        document.getElementById('randomBpm').addEventListener('change', function() {
            if (this.checked && isPlaying) {
                startRandomBPM();
            } else {
                stopRandomBPM();
            }
        });

        document.getElementById('heightSlider').addEventListener('input', function() {
            currentSoundY = parseFloat(this.value);
            targetSoundY = currentSoundY;
            const labels = ['Down', 'Center', 'Up'];
            const index = Math.round((parseFloat(this.value) + 1) * 1);
            document.getElementById('heightLabel').textContent = labels[Math.min(2, Math.max(0, index))];
            if (manualMode && spatialAudioActive) {
                setSoundPosition(currentSoundX, currentSoundY, currentSoundZ);
            }
        });

        document.getElementById('speedSlider').addEventListener('input', function() {
            movementSpeed = parseFloat(this.value);
            const labels = ['Very Slow', 'Slow', 'Normal', 'Fast', 'Very Fast'];
            const index = Math.round((movementSpeed - 0.5) / 0.625);
            document.getElementById('speedLabel').textContent = labels[Math.min(4, Math.max(0, index))];
        });
    }

    // ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•ã®ãƒˆã‚°ãƒ«
    function toggleSmoothMovement() {
        smoothMovement = document.getElementById('smoothMovement').checked;
        const speedControl = document.getElementById('movementSpeedControl');
        
        if (smoothMovement) {
            speedControl.style.display = 'block';
            if (spatialAudioActive && isPlaying && !manualMode) {
                if (spatialInterval) {
                    clearInterval(spatialInterval);
                    spatialInterval = null;
                }
                generateNewPath();
                startSmoothMovement();
            }
        } else {
            speedControl.style.display = 'none';
            if (smoothAnimationFrame) {
                cancelAnimationFrame(smoothAnimationFrame);
                smoothAnimationFrame = null;
            }
            if (spatialAudioActive && isPlaying && !manualMode) {
                updateSpatialPosition();
                spatialInterval = setInterval(() => {
                    updateSpatialPosition();
                }, 2000);
            }
        }
    }

    // æ–°ã—ã„ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
    function generateNewPath() {
        const points = [];
        const numPoints = 3 + Math.floor(Math.random() * 5); // 3-7ç‚¹ã®ãƒ©ãƒ³ãƒ€ãƒ 
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ä½ç½®
        let currentAngle = Math.random() * Math.PI * 2;
        let angleVelocity = (Math.random() - 0.5) * 2; // å›è»¢é€Ÿåº¦
        
        for (let i = 0; i < numPoints; i++) {
            // å›è»¢æ–¹å‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
            if (Math.random() < 0.3) {
                angleVelocity = (Math.random() - 0.5) * 3;
            }
            
            currentAngle += angleVelocity + (Math.random() - 0.5) * 1.5;
            
            // ã‚ˆã‚Šåºƒç¯„å›²ã«ãƒ©ãƒ³ãƒ€ãƒ ãªåŠå¾„
            const radius = 0.1 + Math.random() * 0.8;
            
            // é«˜ã•ã‚‚ã‚ˆã‚Šãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã«
            const height = (Math.random() - 0.5) * 1.2;
            
            points.push({
                x: Math.cos(currentAngle) * radius,
                y: height,
                z: Math.sin(currentAngle) * radius
            });
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã«é–‰ã˜ãŸãƒ‘ã‚¹ã‹é–‹ã„ãŸãƒ‘ã‚¹ã«ã™ã‚‹
        if (Math.random() < 0.5) {
            points.push(points[0]); // é–‰ã˜ã‚‹
        } else {
            // æ–°ã—ã„ãƒ©ãƒ³ãƒ€ãƒ ãªçµ‚ç‚¹
            const endAngle = Math.random() * Math.PI * 2;
            const endRadius = 0.1 + Math.random() * 0.8;
            points.push({
                x: Math.cos(endAngle) * endRadius,
                y: (Math.random() - 0.5) * 1.2,
                z: Math.sin(endAngle) * endRadius
            });
        }
        
        movementPath = points;
        pathProgress = 0;
    }

    // ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹•ã‚’é–‹å§‹
    function startSmoothMovement() {
        if (!smoothMovement || !spatialAudioActive || manualMode) return;
        
        let lastTime = Date.now();
        let pathChangeTimer = 0;
        const pathChangeDuration = 3000 + Math.random() * 4000; // 3-7ç§’ã§ãƒ‘ã‚¹å¤‰æ›´
        
        const animate = () => {
            if (!smoothMovement || !spatialAudioActive || manualMode || !isPlaying) {
                smoothAnimationFrame = null;
                return;
            }
            
            const currentTime = Date.now();
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // ãƒ‘ã‚¹å¤‰æ›´ã‚¿ã‚¤ãƒãƒ¼
            pathChangeTimer += deltaTime;
            if (pathChangeTimer > pathChangeDuration || !movementPath || movementPath.length < 2) {
                generateNewPath();
                pathChangeTimer = 0;
            }
            
            // ãƒ‘ã‚¹ã«æ²¿ã£ã¦ç§»å‹•ï¼ˆé€Ÿåº¦ã‚’2å€ã«ï¼‰
            const speed = movementSpeed * 0.004 * (deltaTime / 16.67); // åŸºæº–é€Ÿåº¦ã‚’2å€ã«
            pathProgress += speed;
            
            if (pathProgress >= movementPath.length - 1) {
                generateNewPath();
                pathProgress = 0;
            }
            
            const index = Math.floor(pathProgress);
            const t = pathProgress - index;
            
            const p1 = movementPath[index];
            const p2 = movementPath[(index + 1) % movementPath.length];
            
            // Catmull-Romè£œé–“ã§ã‚ˆã‚Šæ»‘ã‚‰ã‹ã«
            const p0 = movementPath[Math.max(0, index - 1)];
            const p3 = movementPath[Math.min(movementPath.length - 1, index + 2)];
            
            const t2 = t * t;
            const t3 = t2 * t;
            
            targetSoundX = 0.5 * ((2 * p1.x) + 
                (-p0.x + p2.x) * t + 
                (2 * p0.x - 5 * p1.x + 4 * p2.x - p3.x) * t2 + 
                (-p0.x + 3 * p1.x - 3 * p2.x + p3.x) * t3);
                
            targetSoundY = 0.5 * ((2 * p1.y) + 
                (-p0.y + p2.y) * t + 
                (2 * p0.y - 5 * p1.y + 4 * p2.y - p3.y) * t2 + 
                (-p0.y + 3 * p1.y - 3 * p2.y + p3.y) * t3);
                
            targetSoundZ = 0.5 * ((2 * p1.z) + 
                (-p0.z + p2.z) * t + 
                (2 * p0.z - 5 * p1.z + 4 * p2.z - p3.z) * t2 + 
                (-p0.z + 3 * p1.z - 3 * p2.z + p3.z) * t3);
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚¤ã‚ºã‚’è¿½åŠ 
            const noiseScale = 0.02 * movementSpeed;
            targetSoundX += (Math.random() - 0.5) * noiseScale;
            targetSoundY += (Math.random() - 0.5) * noiseScale;
            targetSoundZ += (Math.random() - 0.5) * noiseScale;
            
            // ç¾åœ¨ä½ç½®ã‚’ç›®æ¨™ä½ç½®ã«å‘ã‘ã¦æ»‘ã‚‰ã‹ã«ç§»å‹•ï¼ˆé€Ÿåº¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
            const lerpFactor = 0.08 * Math.sqrt(movementSpeed);
            currentSoundX += (targetSoundX - currentSoundX) * lerpFactor;
            currentSoundY += (targetSoundY - currentSoundY) * lerpFactor;
            currentSoundZ += (targetSoundZ - currentSoundZ) * lerpFactor;
            
            // å¢ƒç•Œãƒã‚§ãƒƒã‚¯
            const maxDist = 1.0;
            const currentDist = Math.sqrt(currentSoundX * currentSoundX + currentSoundZ * currentSoundZ);
            if (currentDist > maxDist) {
                const scale = maxDist / currentDist;
                currentSoundX *= scale;
                currentSoundZ *= scale;
            }
            currentSoundY = Math.max(-1, Math.min(1, currentSoundY));
            
            // ãƒˆãƒ¬ã‚¤ãƒ«ã‚’æ›´æ–°
            soundTrail.push({ x: currentSoundX, y: currentSoundY, z: currentSoundZ });
            if (soundTrail.length > 30) { // ãƒˆãƒ¬ã‚¤ãƒ«ã‚’å°‘ã—é•·ã
                soundTrail.shift();
            }
            
            setSoundPosition(currentSoundX, currentSoundY, currentSoundZ);
            
            smoothAnimationFrame = requestAnimationFrame(animate);
        };
        
        animate();
    }

    // 3Dç©ºé–“ã®æç”»
    function draw3DSpace() {
        if (!ctx || !canvas) return;
        
        const width = canvas.width = window.innerWidth;
        const height = canvas.height = window.innerHeight;
        
        ctx.clearRect(0, 0, width, height);
        
        const centerX = width / 2;
        const centerY = height / 2;
        const maxRadius = Math.min(width, height) * 0.4;
        
        // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè–„ã„å††ï¼‰
        const bgGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius * 1.5);
        bgGradient.addColorStop(0, 'rgba(102, 126, 234, 0.02)');
        bgGradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = bgGradient;
        ctx.fillRect(0, 0, width, height);
        
        // åŒå¿ƒå††ã‚°ãƒªãƒƒãƒ‰ï¼ˆè·é›¢ã‚’ç¤ºã™å††ï¼‰
        ctx.strokeStyle = 'rgba(102, 126, 234, 0.1)';
        ctx.lineWidth = 1;
        
        // 5ã¤ã®åŒå¿ƒå††ã‚’æç”»ï¼ˆ20%, 40%, 60%, 80%, 100%ã®è·é›¢ï¼‰
        for (let i = 1; i <= 5; i++) {
            const r = (maxRadius / 5) * i;
            ctx.beginPath();
            ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        // ã•ã‚‰ã«ç´°ã‹ã„åŒå¿ƒå††ï¼ˆè–„ãï¼‰
        ctx.strokeStyle = 'rgba(102, 126, 234, 0.05)';
        ctx.lineWidth = 0.5;
        for (let i = 1; i <= 10; i++) {
            const r = (maxRadius / 10) * i;
            ctx.beginPath();
            ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
            ctx.stroke();
        }
        
        // åå­—ç·š
        ctx.strokeStyle = 'rgba(102, 126, 234, 0.08)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY - maxRadius);
        ctx.lineTo(centerX, centerY + maxRadius);
        ctx.moveTo(centerX - maxRadius, centerY);
        ctx.lineTo(centerX + maxRadius, centerY);
        ctx.stroke();
        
        // æ–œã‚ã®è£œåŠ©ç·šï¼ˆ45åº¦ï¼‰
        ctx.strokeStyle = 'rgba(102, 126, 234, 0.04)';
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        const diag = maxRadius * 0.707; // 45åº¦ã®æ™‚ã®é•·ã•
        ctx.moveTo(centerX - diag, centerY - diag);
        ctx.lineTo(centerX + diag, centerY + diag);
        ctx.moveTo(centerX + diag, centerY - diag);
        ctx.lineTo(centerX - diag, centerY + diag);
        ctx.stroke();
        
        // æ–¹å‘ãƒ©ãƒ™ãƒ«
        ctx.fillStyle = 'rgba(102, 126, 234, 0.4)';
        ctx.font = '11px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('FRONT', centerX, centerY - maxRadius - 10);
        ctx.fillText('BACK', centerX, centerY + maxRadius + 20);
        ctx.fillText('LEFT', centerX - maxRadius - 30, centerY + 3);
        ctx.fillText('RIGHT', centerX + maxRadius + 30, centerY + 3);
        
        // ãƒªã‚¹ãƒŠãƒ¼ä½ç½®ï¼ˆä¸­å¿ƒï¼‰
        const listenerGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 12);
        listenerGradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
        listenerGradient.addColorStop(1, 'rgba(102, 126, 234, 0.2)');
        ctx.fillStyle = listenerGradient;
        ctx.beginPath();
        ctx.arc(centerX, centerY, 12, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = 'white';
        ctx.font = 'bold 8px -apple-system, sans-serif';
        ctx.fillText('YOU', centerX, centerY + 2);
        
        // éŸ³æºã®ä½ç½®ï¼ˆ3DåŠ¹æœï¼‰
        if (spatialAudioActive) {
            // ãƒˆãƒ¬ã‚¤ãƒ«ã‚’æç”»ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•æ™‚ï¼‰
            if (smoothMovement && soundTrail.length > 1) {
                ctx.strokeStyle = 'rgba(240, 147, 251, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < soundTrail.length; i++) {
                    const point = soundTrail[i];
                    const x = centerX + point.x * maxRadius;
                    const y = centerY - point.z * maxRadius;
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
            
            const x = centerX + currentSoundX * maxRadius;
            const y = centerY - currentSoundZ * maxRadius;
            const size = 15 + Math.abs(currentSoundY) * 10;
            
            // é«˜ã•ã«ã‚ˆã‚‹è‰²ã®å¤‰åŒ–
            let hue, saturation, lightness;
            if (currentSoundY > 0.3) {
                hue = 340; // ãƒ”ãƒ³ã‚¯ç³»
                saturation = 80;
                lightness = 60;
            } else if (currentSoundY < -0.3) {
                hue = 250; // ç´«ç³»
                saturation = 70;
                lightness = 50;
            } else {
                hue = 280; // ä¸­é–“ï¼ˆè–„ç´«ï¼‰
                saturation = 60;
                lightness = 55;
            }
            
            // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const time = Date.now() / 1000;
            const pulse = Math.sin(time * 3) * 0.2 + 1;
            
            // å¤–å´ã®æ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            for (let i = 3; i > 0; i--) {
                ctx.strokeStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, ${0.15 / i})`;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(x, y, size * pulse + (i * 15), 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // éŸ³æºæœ¬ä½“ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            const soundGradient = ctx.createRadialGradient(x, y, 0, x, y, size);
            soundGradient.addColorStop(0, `hsla(${hue}, ${saturation}%, ${lightness + 20}%, 0.9)`);
            soundGradient.addColorStop(1, `hsla(${hue}, ${saturation}%, ${lightness}%, 0.5)`);
            
            ctx.fillStyle = soundGradient;
            ctx.beginPath();
            ctx.arc(x, y, size * pulse, 0, Math.PI * 2);
            ctx.fill();
            
            // å†…å´ã®å…‰
            ctx.fillStyle = `hsla(${hue}, ${saturation}%, 90%, 0.8)`;
            ctx.beginPath();
            ctx.arc(x, y, size * 0.3, 0, Math.PI * 2);
            ctx.fill();
            
            // é«˜ã•ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
            if (Math.abs(currentSoundY) > 0.1) {
                ctx.save();
                ctx.fillStyle = `hsla(${hue}, ${saturation}%, ${lightness}%, 0.6)`;
                ctx.font = 'bold 16px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                const heightText = currentSoundY > 0 ? 'â–²' : 'â–¼';
                ctx.fillText(heightText, x, y - size - 10);
                ctx.restore();
            }
        }
        
        requestAnimationFrame(draw3DSpace);
    }

    // AudioåˆæœŸåŒ–
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // iOSå¯¾ç­–: ã‚µã‚¹ãƒšãƒ³ãƒ‰çŠ¶æ…‹ã‚’è§£é™¤
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        // iOS Safariå¯¾ç­–: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å†é–‹
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
    }

    // å‘¨æ³¢æ•°ãƒ—ãƒªã‚»ãƒƒãƒˆ
    function setPresetFrequency(ear, freq) {
        if (ear === 'left') {
            document.getElementById('leftFreq').value = freq;
            document.getElementById('leftFreqLabel').textContent = freq + ' Hz';
            document.getElementById('leftFreqDisplay').textContent = freq + ' Hz';
            
            if (isPlaying && leftOscillator) {
                leftOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
        } else if (ear === 'right') {
            document.getElementById('rightFreq').value = freq;
            document.getElementById('rightFreqLabel').textContent = freq + ' Hz';
            document.getElementById('rightFreqDisplay').textContent = freq + ' Hz';
            
            if (isPlaying && rightOscillator) {
                rightOscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            }
        }
        
        updateFrequencyDifference();
    }

    // è„³æ³¢ãƒ—ãƒªã‚»ãƒƒãƒˆ
    function setBrainwavePreset(waveType) {
        const baseFreq = parseFloat(document.getElementById('leftFreq').value);
        let difference = 0;
        
        switch(waveType) {
            case 'delta': difference = 2; break;
            case 'theta': difference = 6; break;
            case 'alpha': difference = 10; break;
            case 'beta': difference = 20; break;
            case 'gamma': difference = 40; break;
        }
        
        const rightFreq = Math.max(20, Math.min(20000, baseFreq + difference));
        
        document.getElementById('rightFreq').value = rightFreq;
        document.getElementById('rightFreqLabel').textContent = rightFreq + ' Hz';
        document.getElementById('rightFreqDisplay').textContent = rightFreq + ' Hz';
        
        updateFrequencyDifference();
        
        if (isPlaying && rightOscillator) {
            rightOscillator.frequency.setValueAtTime(rightFreq, audioContext.currentTime);
        }
    }

    // å‘¨æ³¢æ•°å·®ã®æ›´æ–°
    function updateFrequencyDifference() {
        const leftFreq = parseFloat(document.getElementById('leftFreq').value);
        const rightFreq = parseFloat(document.getElementById('rightFreq').value);
        const diff = Math.abs(rightFreq - leftFreq);
        
        document.getElementById('freqDifference').textContent = diff.toFixed(1) + ' Hz';
        
        let waveType = '';
        if (diff >= 0.5 && diff < 4) waveType = '(Delta)';
        else if (diff >= 4 && diff < 8) waveType = '(Theta)';
        else if (diff >= 8 && diff < 13) waveType = '(Alpha)';
        else if (diff >= 13 && diff < 30) waveType = '(Beta)';
        else if (diff >= 30 && diff <= 50) waveType = '(Gamma)';
        else if (diff > 50) waveType = '(Out of range)';
        else waveType = '(Mono)';
        
        document.getElementById('currentWaveType').textContent = waveType;
    }

    // éŸ³é‡æ›´æ–°
    function updateVolume() {
        if (leftGain && !leftMuted) {
            leftGain.gain.setValueAtTime(0.3 * masterVolume * leftVolume, audioContext.currentTime);
        }
        if (rightGain && !rightMuted) {
            rightGain.gain.setValueAtTime(0.3 * masterVolume * rightVolume, audioContext.currentTime);
        }
    }

    // BPMæ›´æ–°
    function updateBPM(bpm) {
        if (bpmInterval) {
            clearInterval(bpmInterval);
        }
        
        const interval = 60000 / bpm;
        
        bpmInterval = setInterval(() => {
            if (leftGain && rightGain) {
                const now = audioContext.currentTime;
                
                if (!leftMuted) {
                    leftGain.gain.cancelScheduledValues(now);
                    const currentLeftVolume = spatialAudioActive ? leftGain.gain.value : 0.3 * masterVolume * leftVolume;
                    leftGain.gain.setValueAtTime(currentLeftVolume, now);
                    leftGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    leftGain.gain.exponentialRampToValueAtTime(currentLeftVolume, now + 0.1);
                }
                
                if (!rightMuted) {
                    rightGain.gain.cancelScheduledValues(now);
                    const currentRightVolume = spatialAudioActive ? rightGain.gain.value : 0.3 * masterVolume * rightVolume;
                    rightGain.gain.setValueAtTime(currentRightVolume, now);
                    rightGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    rightGain.gain.exponentialRampToValueAtTime(currentRightVolume, now + 0.1);
                }
            }
        }, interval);
    }

    // å·¦è€³ãƒŸãƒ¥ãƒ¼ãƒˆãƒˆã‚°ãƒ«
    function toggleLeftMute() {
        leftMuted = !leftMuted;
        const btn = document.getElementById('leftMuteBtn');
        const text = document.getElementById('leftMuteText');
        
        if (leftMuted) {
            text.textContent = 'Left OFF';
            btn.style.background = 'linear-gradient(135deg, #f093fb, #f5576c)';
            btn.style.color = 'white';
            if (leftGain) {
                leftGain.gain.setValueAtTime(0, audioContext.currentTime);
            }
        } else {
            text.textContent = 'Left ON';
            btn.style.background = 'white';
            btn.style.color = '#333';
            if (leftGain) {
                leftGain.gain.setValueAtTime(0.3 * masterVolume * leftVolume, audioContext.currentTime);
            }
        }
    }

    // å³è€³ãƒŸãƒ¥ãƒ¼ãƒˆãƒˆã‚°ãƒ«
    function toggleRightMute() {
        rightMuted = !rightMuted;
        const btn = document.getElementById('rightMuteBtn');
        const text = document.getElementById('rightMuteText');
        
        if (rightMuted) {
            text.textContent = 'Right OFF';
            btn.style.background = 'linear-gradient(135deg, #f093fb, #f5576c)';
            btn.style.color = 'white';
            if (rightGain) {
                rightGain.gain.setValueAtTime(0, audioContext.currentTime);
            }
        } else {
            text.textContent = 'Right ON';
            btn.style.background = 'white';
            btn.style.color = '#333';
            if (rightGain) {
                rightGain.gain.setValueAtTime(0.3 * masterVolume * rightVolume, audioContext.currentTime);
            }
        }
    }

    // ãƒ©ãƒ³ãƒ€ãƒ BPM
    function startRandomBPM() {
        randomBpmInterval = setInterval(() => {
            const randomBpm = Math.floor(Math.random() * (180 - 60 + 1)) + 60;
            document.getElementById('bpmSlider').value = randomBpm;
            document.getElementById('bpmLabel').textContent = randomBpm + ' BPM';
            updateBPM(randomBpm);
        }, 5000);
    }

    function stopRandomBPM() {
        if (randomBpmInterval) {
            clearInterval(randomBpmInterval);
            randomBpmInterval = null;
        }
    }

    // 3DéŸ³éŸ¿ãƒˆã‚°ãƒ«
    function toggleSpatialAudio() {
        spatialAudioActive = document.getElementById('spatialAudio').checked;
        const heightControl = document.getElementById('heightControl');
        
        if (spatialAudioActive) {
            heightControl.style.display = 'block';
            if (isPlaying) {
                stopSound();
                setTimeout(() => startSound(), 100);
            }
        } else {
            heightControl.style.display = 'none';
            if (spatialInterval) {
                clearInterval(spatialInterval);
                spatialInterval = null;
            }
            if (smoothAnimationFrame) {
                cancelAnimationFrame(smoothAnimationFrame);
                smoothAnimationFrame = null;
            }
            if (isPlaying) {
                stopSound();
                setTimeout(() => startSound(), 100);
            }
        }
    }

    // æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«
    function toggleManualMode() {
        manualMode = document.getElementById('manualMode').checked;
        
        if (spatialAudioActive && isPlaying) {
            if (manualMode) {
                if (spatialInterval) {
                    clearInterval(spatialInterval);
                    spatialInterval = null;
                }
                if (smoothAnimationFrame) {
                    cancelAnimationFrame(smoothAnimationFrame);
                    smoothAnimationFrame = null;
                }
            } else {
                if (smoothMovement) {
                    generateNewPath();
                    startSmoothMovement();
                } else {
                    updateSpatialPosition();
                    spatialInterval = setInterval(() => {
                        updateSpatialPosition();
                    }, 2000);
                }
            }
        }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œ
    function startDrag(event) {
        if (!spatialAudioActive || !manualMode) return;
        isDragging = true;
        event.preventDefault();
    }

    function drag(event) {
        if (!isDragging || !spatialAudioActive || !manualMode) return;
        
        event.preventDefault();
        const rect = canvas.getBoundingClientRect();
        
        let x, y;
        if (event.type.includes('touch')) {
            x = ((event.touches[0].clientX - rect.left) / rect.width) * canvas.width;
            y = ((event.touches[0].clientY - rect.top) / rect.height) * canvas.height;
        } else {
            x = ((event.clientX - rect.left) / rect.width) * canvas.width;
            y = ((event.clientY - rect.top) / rect.height) * canvas.height;
        }
        
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const maxRadius = Math.min(canvas.width, canvas.height) * 0.4;
        const dx = (x - centerX) / maxRadius;
        const dz = -(y - centerY) / maxRadius;
        
        const distance = Math.sqrt(dx * dx + dz * dz);
        if (distance <= 1) {
            currentSoundX = dx;
            currentSoundZ = dz;
            targetSoundX = dx;
            targetSoundZ = dz;
            setSoundPosition(currentSoundX, currentSoundY, currentSoundZ);
        }
    }

    function endDrag() {
        isDragging = false;
    }

    // éŸ³æºä½ç½®è¨­å®š
    function setSoundPosition(x, y, z) {
        if (!pannerNode || !isPlaying) return;
        
        // ã‚ˆã‚Šå¼·èª¿ã•ã‚ŒãŸ3Dä½ç½®è¨­å®š
        pannerNode.positionX.setValueAtTime(x * 3, audioContext.currentTime);
        pannerNode.positionY.setValueAtTime(y * 3, audioContext.currentTime);
        pannerNode.positionZ.setValueAtTime(z * 3, audioContext.currentTime);
        
        // ãƒ‘ãƒ³ãƒŠãƒ¼ã®è·é›¢ãƒ¢ãƒ‡ãƒ«ã‚’ã‚ˆã‚Šå¼·èª¿
        pannerNode.refDistance = 0.5;
        pannerNode.maxDistance = 15;
        pannerNode.rolloffFactor = 2;
        
        if (lowpassFilter && highpassFilter) {
            let lowpassFreq = 20000;
            let highpassFreq = 20;
            
            // å‰å¾Œã®ä½ç½®ã«ã‚ˆã‚‹å¤‰åŒ–ã‚’å¼·èª¿
            if (z < 0) {
                // å¾Œã‚ï¼šã“ã‚‚ã£ãŸéŸ³ï¼ˆä½åŸŸå¼·èª¿ï¼‰
                lowpassFreq = 1500 - (Math.abs(z) * 1000);
                highpassFreq = 20;
            } else {
                // å‰ï¼šã‚¯ãƒªã‚¢ãªéŸ³ï¼ˆé«˜åŸŸã‚‚å«ã‚€ï¼‰
                lowpassFreq = 10000 + (z * 10000);
                highpassFreq = 100 + (z * 200);
            }
            
            // ä¸Šä¸‹ã®ä½ç½®ã«ã‚ˆã‚‹å¤‰åŒ–ã‚’å¼·èª¿
            if (y > 0) {
                // ä¸Šï¼šæ˜ã‚‹ã„éŸ³
                lowpassFreq = Math.min(20000, lowpassFreq + (y * 5000));
                highpassFreq = Math.max(20, highpassFreq + (y * 300));
            } else if (y < 0) {
                // ä¸‹ï¼šæš—ã„éŸ³
                lowpassFreq = Math.max(800, lowpassFreq + (y * 8000));
                highpassFreq = Math.max(20, highpassFreq - (Math.abs(y) * 50));
            }
            
            // å·¦å³ã®ä½ç½®ã«ã‚ˆã‚‹éŸ³é‡å·®ã‚’è¿½åŠ ï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆçŠ¶æ…‹ã‚’è€ƒæ…®ï¼‰
            const stereoBalance = x; // -1 (å·¦) to 1 (å³)
            if (leftGain && rightGain) {
                const leftAdjust = 1 - Math.max(0, stereoBalance * 0.5);
                const rightAdjust = 1 + Math.min(0, stereoBalance * 0.5);
                
                if (!leftMuted) {
                    leftGain.gain.setValueAtTime(
                        0.3 * masterVolume * leftVolume * leftAdjust, 
                        audioContext.currentTime
                    );
                }
                
                if (!rightMuted) {
                    rightGain.gain.setValueAtTime(
                        0.3 * masterVolume * rightVolume * rightAdjust, 
                        audioContext.currentTime
                    );
                }
            }
            
            lowpassFilter.frequency.setValueAtTime(lowpassFreq, audioContext.currentTime);
            highpassFilter.frequency.setValueAtTime(highpassFreq, audioContext.currentTime);
            
            // Qå€¤ï¼ˆå…±é³´ï¼‰ã‚‚ä½ç½®ã«å¿œã˜ã¦å¤‰æ›´
            const qValue = 1 + Math.abs(z) * 3 + Math.abs(y) * 2;
            lowpassFilter.Q.setValueAtTime(qValue, audioContext.currentTime);
            highpassFilter.Q.setValueAtTime(qValue * 0.5, audioContext.currentTime);
        }
        
        updatePositionDisplay(x, y, z);
    }

    // ä½ç½®è¡¨ç¤ºæ›´æ–°
    function updatePositionDisplay(x, y, z) {
        let position = '';
        
        if (Math.abs(x) > 0.3) {
            position += x > 0 ? 'Right ' : 'Left ';
        }
        
        if (Math.abs(z) > 0.3) {
            position += z > 0 ? 'Front' : 'Back';
        }
        
        if (position === '') position = 'Center';
        
        const distance = Math.sqrt(x*x + y*y + z*z);
        const distanceText = distance < 0.5 ? 'Near' : distance < 1 ? 'Mid' : 'Far';
        
        let height = '';
        if (Math.abs(y) > 0.3) {
            height = y > 0 ? 'Up' : 'Down';
        } else {
            height = 'Center';
        }
        
        document.getElementById('spatialPosition').textContent = `${position} (${height}, ${distanceText})`;
    }

    // ç©ºé–“ä½ç½®æ›´æ–°
    function updateSpatialPosition() {
        if (!spatialAudioActive || manualMode) return;
        
        const theta = Math.random() * Math.PI * 2;
        const phi = (Math.random() - 0.5) * Math.PI;
        const radius = 0.3 + Math.random() * 0.7;
        
        currentSoundX = Math.cos(theta) * Math.cos(phi) * radius;
        currentSoundY = Math.sin(phi) * radius;
        currentSoundZ = Math.sin(theta) * Math.cos(phi) * radius;
        
        targetSoundX = currentSoundX;
        targetSoundY = currentSoundY;
        targetSoundZ = currentSoundZ;
        
        setSoundPosition(currentSoundX, currentSoundY, currentSoundZ);
    }

    // å†ç”Ÿ/åœæ­¢
    function togglePlay() {
        if (!isPlaying) {
            startSound();
        } else {
            stopSound();
        }
    }

    function startSound() {
        initAudio();
        
        // iOSå¯¾ç­–: AudioContextãŒç¢ºå®Ÿã«å‹•ä½œã™ã‚‹ã¾ã§å¾…æ©Ÿ
        const startAudioContext = () => {
            if (audioContext.state === 'suspended') {
                return audioContext.resume();
            }
            return Promise.resolve();
        };
        
        startAudioContext().then(() => {
            enterFullscreen();
            
            const leftFreq = parseFloat(document.getElementById('leftFreq').value);
            const rightFreq = parseFloat(document.getElementById('rightFreq').value);
            const bpm = parseFloat(document.getElementById('bpmSlider').value);
            
            // iOSå¯¾ç­–: ãƒ€ãƒŸãƒ¼ã®éŸ³ã‚’ä¸€ç¬å†ç”Ÿã—ã¦ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºå®Ÿã«é–‹å§‹
            const dummy = audioContext.createOscillator();
            const dummyGain = audioContext.createGain();
            dummy.connect(dummyGain);
            dummyGain.connect(audioContext.destination);
            dummyGain.gain.value = 0.001;
            dummy.start();
            dummy.stop(audioContext.currentTime + 0.01);
            
            setTimeout(() => {
                leftOscillator = audioContext.createOscillator();
                leftGain = audioContext.createGain();
                leftOscillator.frequency.value = leftFreq;
                leftOscillator.type = 'sine';
                leftGain.gain.value = leftMuted ? 0 : 0.3 * masterVolume * leftVolume;
                
                rightOscillator = audioContext.createOscillator();
                rightGain = audioContext.createGain();
                rightOscillator.frequency.value = rightFreq;
                rightOscillator.type = 'sine';
                rightGain.gain.value = rightMuted ? 0 : 0.3 * masterVolume * rightVolume;
                
                merger = audioContext.createChannelMerger(2);
                
                if (spatialAudioActive) {
                    pannerNode = audioContext.createPanner();
                    pannerNode.panningModel = 'HRTF';
                    pannerNode.distanceModel = 'inverse';
                    pannerNode.refDistance = 0.5;
                    pannerNode.maxDistance = 15;
                    pannerNode.rolloffFactor = 2;
                    pannerNode.coneInnerAngle = 360;
                    pannerNode.coneOuterAngle = 360;
                    pannerNode.coneOuterGain = 0;
                    
                    if (audioContext.listener.forwardX) {
                        audioContext.listener.forwardX.setValueAtTime(0, audioContext.currentTime);
                        audioContext.listener.forwardY.setValueAtTime(0, audioContext.currentTime);
                        audioContext.listener.forwardZ.setValueAtTime(-1, audioContext.currentTime);
                        audioContext.listener.upX.setValueAtTime(0, audioContext.currentTime);
                        audioContext.listener.upY.setValueAtTime(1, audioContext.currentTime);
                        audioContext.listener.upZ.setValueAtTime(0, audioContext.currentTime);
                    }
                    
                    lowpassFilter = audioContext.createBiquadFilter();
                    lowpassFilter.type = 'lowpass';
                    lowpassFilter.frequency.value = 20000;
                    lowpassFilter.Q.value = 1;
                    
                    highpassFilter = audioContext.createBiquadFilter();
                    highpassFilter.type = 'highpass';
                    highpassFilter.frequency.value = 20;
                    highpassFilter.Q.value = 0.7;
                    
                    const compressor = audioContext.createDynamicsCompressor();
                    compressor.threshold.value = -24;
                    compressor.knee.value = 30;
                    compressor.ratio.value = 12;
                    compressor.attack.value = 0.003;
                    compressor.release.value = 0.25;
                    
                    leftOscillator.connect(leftGain);
                    leftGain.connect(merger, 0, 0);
                    
                    rightOscillator.connect(rightGain);
                    rightGain.connect(merger, 0, 1);
                    
                    merger.connect(lowpassFilter);
                    lowpassFilter.connect(highpassFilter);
                    highpassFilter.connect(compressor);
                    compressor.connect(pannerNode);
                    pannerNode.connect(audioContext.destination);
                } else {
                    leftOscillator.connect(leftGain);
                    leftGain.connect(merger, 0, 0);
                    
                    rightOscillator.connect(rightGain);
                    rightGain.connect(merger, 0, 1);
                    
                    merger.connect(audioContext.destination);
                }
                
                leftOscillator.start();
                rightOscillator.start();
                
                updateBPM(bpm);
                
                if (document.getElementById('randomBpm').checked) {
                    startRandomBPM();
                }
                
                if (spatialAudioActive) {
                    setTimeout(() => {
                        if (!manualMode) {
                            if (smoothMovement) {
                                generateNewPath();
                                startSmoothMovement();
                            } else {
                                updateSpatialPosition();
                                spatialInterval = setInterval(() => {
                                    updateSpatialPosition();
                                }, 2000);
                            }
                        } else {
                            setSoundPosition(currentSoundX, currentSoundY, currentSoundZ);
                        }
                    }, 100);
                }
                
                isPlaying = true;
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
            }, 50);
        }).catch(err => {
            console.error('AudioContext start error:', err);
        });
    }

    function stopSound() {
        if (leftOscillator) {
            leftOscillator.stop();
            leftOscillator = null;
        }
        if (rightOscillator) {
            rightOscillator.stop();
            rightOscillator = null;
        }
        
        leftGain = null;
        rightGain = null;
        merger = null;
        pannerNode = null;
        lowpassFilter = null;
        highpassFilter = null;
        
        if (bpmInterval) {
            clearInterval(bpmInterval);
            bpmInterval = null;
        }
        
        stopRandomBPM();
        
        if (spatialInterval) {
            clearInterval(spatialInterval);
            spatialInterval = null;
        }
        
        if (smoothAnimationFrame) {
            cancelAnimationFrame(smoothAnimationFrame);
            smoothAnimationFrame = null;
        }
        
        soundTrail = [];
        
        isPlaying = false;
        document.getElementById('playBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
    }

    // æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    function openInfoModal() {
        document.getElementById('infoModal').classList.add('active');
    }
    
    function closeInfoModal() {
        document.getElementById('infoModal').classList.remove('active');
    }
    
    function closeInfoModalOnBackground(event) {
        if (event.target === document.getElementById('infoModal')) {
            closeInfoModal();
        }
    }
    
    function switchTab(tabName) {
        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
        const tabs = document.querySelectorAll('.info-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        
        // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
        document.getElementById('usageTab').style.display = 'none';
        document.getElementById('scienceTab').style.display = 'none';
        
        // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        if (tabName === 'usage') {
            tabs[0].classList.add('active');
            document.getElementById('usageTab').style.display = 'block';
        } else if (tabName === 'science') {
            tabs[1].classList.add('active');
            document.getElementById('scienceTab').style.display = 'block';
        }
    }

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚
    window.addEventListener('beforeunload', function() {
        if (isPlaying) {
            stopSound();
        }
    });
</script>
```

</body>
</html>
